name: stock_screen (weekday 20:00 JST)

on:
  schedule:
    - cron: "0 11 * * 1-5"   # 20:00 JST (UTC+9)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write

    concurrency:
      group: stock_screen_20jst
      cancel-in-progress: false

    steps:
      - name: Checkout (full history for branch ops)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download data_e.xls (JPX)
        run: |
          curl -L -o data_e.xls "https://www.jpx.co.jp/english/markets/statistics-equities/misc/tvdivq0000001vg2-att/data_e.xls"
          test -s data_e.xls
          ls -l data_e.xls

      - name: Run screen
        env:
          TZ: Asia/Tokyo
        run: |
          python screen_yearend.py
          ls -la
          ls -la screen_*.csv || true

      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: screen_csv_${{ github.run_id }}
          path: |
            screen_*.csv

      - name: Archive CSVs to data branch
        shell: bash
        env:
          TZ: Asia/Tokyo
        run: |
          set -euo pipefail
          export TZ=Asia/Tokyo

          # 0) CSVがあるか確認
          shopt -s nullglob
          all_files=(screen_*.csv)
          if [ ${#all_files[@]} -eq 0 ]; then
            echo "No screen_*.csv found. Existing files:"
            ls -la
            exit 1
          fi

          # 1) 生成CSVから「最新日」を抽出（YYYY-MM-DDなら辞書順=時系列でOK）
          latest="$(printf '%s\n' "${all_files[@]}" | sort | tail -n 1)"  # 例: screen_2026-01-07_all.csv
          day="${latest#screen_}"
          day="${day%%_*}"

          # 当日分だけ
          files=(screen_"${day}"_*.csv)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No CSV for day=${day}. Existing:"
            ls -la
            exit 1
          fi

          # 退避（ブランチ切替で消えるのを防ぐ）
          rm -rf /tmp/screen_csv
          mkdir -p /tmp/screen_csv
          cp -f "${files[@]}" /tmp/screen_csv/

          # 2) dataブランチへ
          git fetch origin data || true
          if git show-ref --verify --quiet refs/remotes/origin/data; then
            git checkout -B data origin/data
          else
            git checkout -b data
          fi

          # 3) 日付アーカイブ（元ファイル名のまま）
          mkdir -p "archive/${day}"
          cp -f /tmp/screen_csv/*.csv "archive/${day}/"

          # 4) latest固定名
          latest_src=(/tmp/screen_csv/*.csv)
          if [ ${#latest_src[@]} -eq 0 ]; then
            echo "No staged CSVs in /tmp/screen_csv (unexpected)."
            exit 1
          fi

          mkdir -p "archive/latest"
          for f in "${latest_src[@]}"; do
            base="$(basename "$f")"                 # screen_2026-01-07_all.csv
            kind="${base#screen_${day}_}"           # all.csv
            kind="${kind%.csv}"                     # all
            cp -f "$f" "archive/latest/${kind}.csv" # latest/all.csv
          done

          git add -f archive
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "archive: ${day}" || echo "no changes"
          git push origin data
